
como la mayoría de los posts son recordatorios para cuando lo tenga que hacer de nuevo y me haya olvidado y por si a alguien le sirve :D<br/><br/>principalmente seguí estas dos guías<br/><br/><a href="http://github.com/rnewson/couchdb-lucene">http://github.com/rnewson/couchdb-lucene</a><br/><a href="http://wiki.fluidproject.org/pages/viewpage.action?pageId=6823331">http://wiki.fluidproject.org/pages/viewpage.action?pageId=6823331</a><br/><br/>pero siempre la generalidad termina dejando algunas cosas flotando que hacen que uno pelee (hasta que mira "watch tail /usr/local/var/log/couchdb/couch.log")<br/><br/>supongo que tienen instalado y andando couchdb 0.10.0 (va a ser el caso si usan ubuntu karmic :)<br/><br/>lo primero que hacemos es bajar la versión estable de couchdb-lucene (actualmente la 0.4)<br/><br/><pre><br/>wget http://cloud.github.com/downloads/rnewson/couchdb-lucene/couchdb-lucene-0.4-jar-with-dependencies.jar.gz<br/></pre><br/><br/>luego (como dice el README que uno no lee) desempacamos el jar.gz con unpack200, si lo desempacamos con file-roller  java se queja de que es un jar corrupto.<br/><br/><pre><br/>unpack200 couchdb-lucene-0.4-jar-with-dependencies.jar.gz couchdb-lucene-0.4-jar-with-dependencies.jar<br/></pre><br/><br/>creamos un directorio donde lucene pueda trabajar tranquilo<br/><br/><pre><br/>sudo mkdir /usr/local/var/lib/lucene<br/></pre><br/><br/>copiamos el jar<br/><br/><pre><br/>sudo cp couchdb-lucene-0.4-jar-with-dependencies.jar /usr/local/var/lib/lucene<br/></pre><br/><br/>cambiamos el dueño y los permisos al directorio<br/><br/><pre><br/>chown -R couchdb:couchdb /usr/local/var/lib/lucene<br/>chmod -R 0770 /usr/local/var/lib/lucene<br/></pre><br/><br/>configuramos couchdb para que use lucene como indexador de full text search<br/><br/><pre><br/>sudo vim /usr/local/etc/couchdb/local.ini<br/></pre><br/><br/>(mi archivo local.ini tiene lo siguiente)<br/><br/><pre><br/>; CouchDB Configuration Settings<br/><br/>; Custom settings should be made in this file. They will override settings<br/>; in default.ini, but unlike changes made to default.ini, this file won't be<br/>; overwritten on server upgrade.<br/><br/>[couchdb]<br/>;max_document_size = 4294967296 ; bytes<br/><br/>[httpd]<br/>;port = 5984<br/>;bind_address = 127.0.0.1<br/><br/>[log]<br/>;level = debug<br/><br/>[couch_httpd_auth]<br/>;secret = replace this with a real secret<br/><br/>[external]<br/>fti=/usr/bin/java -Dcouchdb.lucene.dir=/usr/local/var/lib/lucene -jar /usr/local/var/lib/lucene/couchdb-lucene-0.4-jar-with-dependencies.jar -search<br/><br/>[update_notification]<br/>indexer=/usr/bin/java -Dcouchdb.lucene.dir=/usr/local/var/lib/lucene -jar /usr/local/var/lib/lucene/couchdb-lucene-0.4-jar-with-dependencies.jar -index<br/><br/>[couchdb]<br/>os_process_timeout=60000 ; increase the timeout to 60 seconds.<br/><br/>[httpd_db_handlers]<br/>_fti = {couch_httpd_external, handle_external_req, &gt;}<br/><br/>; To create an admin account uncomment the '[admins]' section below and add a<br/>; line in the format 'username = password'. When you next start CouchDB, it<br/>; will change the password to a hash (so that your passwords don't linger<br/>; around in plain-text files). You can add more admin accounts with more<br/>; 'username = password' lines. Don't forget to restart CouchDB after<br/>; changing this.<br/>[admins]<br/>marianoguerra = mysecretpassword<br/>;admin = mysecretpassword<br/></pre><br/><br/>(no, ese no es mi password :)<br/><br/>reiniciamos couchdb (lo matamos y lo levantamos de nuevo, esto depende de como lo levantaste, si no sabes, hace "ps aux | grep couchdb" y mata todo lo que parezca sospechoso :D)<br/><br/>lo levantamos de nuevo (yo lo levanto así)<br/><br/><pre><br/>sudo -i -u couchdb couchdb -b<br/></pre><br/><br/>vamos a la interfaz de administracion:<br/><br/><pre><br/>firefox http://localhost:5984/_utils/<br/></pre><br/><br/>elegimos nuestra base de datos, elegimos crear nuevo documento, clickeamos la pestaña source arriba a la derecha y pegamos algo parecido a lo siguiente:<br/><br/><pre><br/>{<br/>   "_id": "_design/search-docs",<br/>   "fulltext": {<br/>       "by_title": {<br/>           "index": "function(doc) { var ret=new Document(); ret.add(doc.title); return ret }"<br/>       },<br/>       "by_content": {<br/>           "index": "function(doc) { var ret=new Document(); ret.add(doc.body); return ret }"<br/>       }<br/>   }<br/>}<br/></pre><br/><br/>el _id cambia por el nombre que mas te guste, las vistas que están adentro de fulltext también cambian según por que quieras indexar, yo estoy indexando por titulo y contenido de unos documentos.<br/><br/>ahora agregamos algunos documentos que puedan ser indexados, para sacarnos la duda de que lucene esta andando mirar la salida de /usr/local/var/log/couchdb/couch.log no debería haber mensajes de error y "ls /usr/local/var/lib/lucene" nos tendia que mostrar varios archivos de nombres extravagantes.<br/><br/>para probar nuestra búsqueda luego de agregar algunos documentos hacemos una query (yo agregue un documento que decía ficticio por todos lados :D)<br/><br/><pre><br/>curl http://localhost:5984/fresita/_fti/search-docs/by_title?q=ficticio<br/></pre><br/><br/>lo cual me devolvió<br/><br/><pre><br/>{"q":"default:ficticio","etag":"1244bf34b28","view_sig":"7368cf7d6f68ec4c60f40c52303de534","skip":0,"limit":25,"total_rows":1,"search_duration":14,"fetch_duration":0,"rows":[{"id":"9ed8514725e1dca56c57471286f5f389","score":2.556901454925537}]}<br/></pre>
<div style="clear: both;"/>
