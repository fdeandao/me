
que sucede si queres hacer un redirect en couchdb?<br/>que sucede si queres hacer un request a otro host desde js y debido al same origin policy no lo podes hacer?<br/>[Insertar otras preguntas cuya respuesta sea lo que voy a explicar aqui]<br/><br/>mi primer opcion fue leventar un servercito de python en otro puerto, pero eso me complicaba porque violaba el same origin policy y tenia que hacer cosas feas con iframes.<br/><br/>entonces me puse a leer el <a href="http://svn.apache.org/viewvc/couchdb/trunk/src/couchdb/">codigo fuente de couchdb</a> (no hay mucha info en otro lado sobre como hacerlo) y vi que la mayoria de los handlers son extensiones en couchdb.<br/><br/>Si se fijan en el archivo de configuracion, van a ver algo como<br/><br/><pre><br/>[httpd_global_handlers]<br/>/ = {couch_httpd_misc_handlers, handle_welcome_req, &gt;}<br/>favicon.ico = {couch_httpd_misc_handlers, handle_favicon_req, "/usr/share/couchdb/www"}<br/><br/>_utils = {couch_httpd_misc_handlers, handle_utils_dir_req, "/usr/share/couchdb/www"}<br/><br/>[snip]<br/></pre><br/><br/>lo que hace eso es que mapea urls a handlers escritos en erlang, el primer elemento de la tupla es el modulo, el segundo es la funcion y el resto son parametros a la funcion.<br/><br/>mi primer experimento fue hacer un redirect para que la url de mi couchapp no quede tan fea, agregue estas linea en /etc/couchdb/local.ini (las otras se veran mas adelante):<br/><br/><pre><br/>editor = {fresita, redirect_editor}<br/>_export = {fresita, export_document}<br/>_style = {fresita, export_style}<br/></pre><br/><br/>y escribi un modulo que se ve asi:<br/><br/><div class="highlight"><pre><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">fresita</span><span class="p">).</span><br/><span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">redirect_editor</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">export_document</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">export_style</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span><br/><br/><span class="nf">redirect_editor</span><span class="p">(</span><span class="nv">Req</span><span class="p">)</span> <span class="o">-&gt;</span><br/><span class="nn">couch_httpd</span><span class="p">:</span><span class="n">send_redirect</span><span class="p">(</span><span class="nv">Req</span><span class="p">,</span> <span class="s">"/fresita/_design/fresita/index.html"</span><span class="p">).</span><br/><br/><span class="nf">export_document</span><span class="p">(</span><span class="nv">Req</span><span class="p">)</span> <span class="o">-&gt;</span><br/><span class="s">"/"</span> <span class="o">++</span> <span class="nv">UrlPath</span> <span class="o">=</span> <span class="nn">couch_httpd</span><span class="p">:</span><span class="n">path</span><span class="p">(</span><span class="nv">Req</span><span class="p">),</span><br/><span class="p">[_</span><span class="nv">Export</span><span class="p">,</span> <span class="nv">Database</span><span class="p">,</span> <span class="nv">InputId</span><span class="p">,</span> <span class="nv">Output</span><span class="p">,</span> <span class="nv">StyleId</span><span class="p">,</span> <span class="nv">Format</span><span class="p">,</span> <span class="p">_</span><span class="nv">FileName</span><span class="p">]</span> <span class="o">=</span> <span class="nn">string</span><span class="p">:</span><span class="n">tokens</span><span class="p">(</span><span class="nv">UrlPath</span><span class="p">,</span> <span class="s">"/"</span><span class="p">),</span><br/><span class="nv">Command</span> <span class="o">=</span> <span class="s">"python /var/lib/fop/export.py --type id --input "</span> <span class="o">++</span> <span class="nv">InputId</span><br/><span class="o">++</span> <span class="s">" --output /tmp/"</span> <span class="o">++</span> <span class="nv">Output</span> <span class="o">++</span> <span class="s">" --style "</span> <span class="o">++</span> <span class="nv">StyleId</span> <span class="o">++</span> <span class="s">" --format "</span><br/><span class="o">++</span> <span class="nv">Format</span> <span class="o">++</span> <span class="s">" --url http://localhost:5984/"</span> <span class="o">++</span> <span class="nv">Database</span> <span class="o">++</span> <span class="s">"/"</span><span class="p">,</span><br/><span class="n">log</span><span class="p">(</span><span class="nv">UrlPath</span><span class="p">),</span><br/><span class="n">log</span><span class="p">(</span><span class="nv">Command</span><span class="p">),</span><br/><span class="nn">os</span><span class="p">:</span><span class="n">cmd</span><span class="p">(</span><span class="nv">Command</span><span class="p">),</span><br/><span class="nn">couch_httpd</span><span class="p">:</span><span class="n">serve_file</span><span class="p">(</span><span class="nv">Req</span><span class="p">,</span> <span class="nv">Output</span> <span class="o">++</span> <span class="s">"."</span> <span class="o">++</span> <span class="nv">Format</span><span class="p">,</span> <span class="s">"/tmp/"</span><span class="p">).</span><br/><br/><span class="nf">export_style</span><span class="p">(</span><span class="nv">Req</span><span class="p">)</span> <span class="o">-&gt;</span><br/><span class="s">"/"</span> <span class="o">++</span> <span class="nv">UrlPath</span> <span class="o">=</span> <span class="nn">couch_httpd</span><span class="p">:</span><span class="n">path</span><span class="p">(</span><span class="nv">Req</span><span class="p">),</span><br/><span class="p">[_</span><span class="nv">Style</span><span class="p">,</span> <span class="nv">Database</span><span class="p">,</span> <span class="nv">StyleId</span><span class="p">]</span> <span class="o">=</span> <span class="nn">string</span><span class="p">:</span><span class="n">tokens</span><span class="p">(</span><span class="nv">UrlPath</span><span class="p">,</span> <span class="s">"/"</span><span class="p">),</span><br/><span class="nn">os</span><span class="p">:</span><span class="n">cmd</span><span class="p">(</span><span class="s">"python /var/lib/fop/export.py --type style --style "</span> <span class="o">++</span><br/><span class="nv">StyleId</span> <span class="o">++</span> <span class="s">" --url http://localhost:5984/"</span> <span class="o">++</span> <span class="nv">Database</span> <span class="o">++</span> <span class="s">"/&gt;/tmp/"</span> <span class="o">++</span><br/><span class="nv">StyleId</span><span class="p">),</span><br/><span class="nn">couch_httpd</span><span class="p">:</span><span class="n">serve_file</span><span class="p">(</span><span class="nv">Req</span><span class="p">,</span> <span class="nv">StyleId</span><span class="p">,</span> <span class="s">"/tmp/"</span><span class="p">).</span><br/><br/><span class="nf">log</span><span class="p">(</span><span class="nv">Text</span><span class="p">)</span> <span class="o">-&gt;</span><br/><span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Device</span><span class="p">}</span> <span class="o">=</span> <span class="nn">file</span><span class="p">:</span><span class="n">open</span><span class="p">(</span><span class="s">"/tmp/fresita.log"</span><span class="p">,</span> <span class="p">[</span><span class="n">append</span><span class="p">]),</span><br/><span class="nn">file</span><span class="p">:</span><span class="n">write</span><span class="p">(</span><span class="nv">Device</span><span class="p">,</span> <span class="nv">Text</span> <span class="o">++</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">).</span><br/></pre></div><br/><br/>lo que hace redirect es simplemente redirigir la url a otra que es mas compleja, los otros dos corren procesos externos y devuelven el contenido al browser (el primero genera pdf y rtf usando apache fop y el segundo hace un merge de algunas cosas).<br/><br/>con esto quiero documentar algo que seguro me voy a olvidar en el futuro y aportar mi granito de arena a couchdb para hacer cosas que se complican si solo tenes couchdb y el frontend en el browser.<br/><br/>para hacer andar esto compilas el archivo con erlc archivo.erl y lo pones en algun lugar donde erlang busque, yo lo puse donde estan todas las otras extensiones de couchdb (/usr/lib/couchdb/erlang/lib/couch-0.10.0/ebin/)
<div style="clear: both;"/>
